name: Deploy to DigitalOcean

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to droplet
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DROPLET_IP }}
        username: root
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd ~/django-web-portfolio/mysite
          git pull origin main
          
          # Export environment variables from GitHub Secrets
          export USE_POSTGRES="${{ secrets.USE_POSTGRES }}"
          export POSTGRES_DB="${{ secrets.POSTGRES_DB }}"
          export POSTGRES_USER="${{ secrets.POSTGRES_USER }}"
          export POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}"
          export DB_HOST="${{ secrets.DB_HOST }}"
          export DB_PORT="${{ secrets.DB_PORT }}"
          export SECRET_KEY="${{ secrets.SECRET_KEY }}"
          export DEBUG="${{ secrets.DEBUG }}"
          export ALLOWED_HOSTS="${{ secrets.ALLOWED_HOSTS }}"
          
          # Run deployment script (will create .env from exported variables)
          chmod +x deploy.sh
          ./deploy.sh
